---
title: "データの整理（1）"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(gradethis)
library(learnr)
library(joholearnr)
library(learnrhash)
suppressPackageStartupMessages(library(tidyverse))

gradethis::gradethis_setup()

tutorial_options(exercise.reveal_solution = FALSE)

moodle_url <- "https://moodle.gs.chiba-u.jp/moodle/mod/assign/view.php?id=1293876"
```

## 準備

必要なパッケージをロードしてから、今回の課題に使うデータを読み込みましょう。

今回のデータはURLから読み込みます。世界各国の経済データを含む「gapminder」というデータセットです。このデータセットについて詳しく知りたい場合は、<https://www.gapminder.org/> を参照してください。

まずは生データを読み込み、`gapminder_raw`として保存します。

```{r tidyverse-example, exercise = TRUE, exercise.lines = 6}
library(tidyverse)

gapminder_raw <- read_csv("https://raw.githubusercontent.com/swcarpentry/r-novice-gapminder/main/episodes/data/gapminder_data.csv")

gapminder_raw
```

### データの説明

`gapminder_raw`には以下の列があります：

- `country`: 国
- `year`: 年
- `pop`: 人口
- `continent`: 大陸
- `lifeExp`: 寿命（"Life Expectancy"）
- `gdpPercap`: 一人当たりの国内総生産（"GDP per capita"）

## 列名を変更する

`gapminder_raw`には、大文字と小文字が混ざっている列名があります：`lifeExp`と`gdpPercap`。

- Q1: `rename()`または`clean_names()`関数を使って、この列名を`life_exp`と`gdp_percap`というふうに変更してください（`clean_names()`を使う場合は`janitor`パッケージをロードする必要があります）。`gapminder`というオブジェクトとして保存し、最後に`gapminder`の中身を表示してください。

```{r load-data-hide, echo = FALSE}
gapminder_raw <- read_csv("https://raw.githubusercontent.com/swcarpentry/r-novice-gapminder/main/episodes/data/gapminder_data.csv")
```

```{r rename-gapminder, exercise = TRUE, exercise.lines = 7, exercise.setup = "load-data-hide"}
# 列名を変更する
gapminder <- _____

# 保存したデータの中身を確認する
____
```

```{r clean-gapminder, echo = FALSE, exercise.setup = "load-data-hide"}
gapminder <- janitor::clean_names(gapminder_raw)
```

```{r rename-gapminder-check}
gapminder <- janitor::clean_names(gapminder_raw)
grade_this({
  fail_if_not_equal(
    x = last_user_code_call(.user_code),
    y = "gapminder",
    message = "最後に gapminder でデータの中身を表示する必要があります"
  )
  pass_if_equal(
    x = as.data.frame(.result),
    y = as.data.frame(gapminder)
  )
  fail()
})
```

### データの説明

列名を変更した結果、`gapminder`の列は次のようになります：

- `country`: 国
- `year`: 年
- `pop`: 人口
- `continent`: 大陸
- `life_exp`: 寿命（"Life Expectancy"）
- `gdp_percap`: 一人当たりの国内総生産（"GDP per capita"）

## データを絞る

- Q2: `filter()`関数を使って、`gapminder`から日本（"Japan"）のデータのみを抽出してください（結果は新しいオブジェクトとして保存する必要はありませんが、コードの出力はデータフレームにしてください）。
  - ヒント：`filter()`に使う条件の記号については、[講義のスライド](https://joelnitta.github.io/joho-shori/day4/#/%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%AF%94%E8%BC%83)を参考にしてください。

```{r filter-japan, exercise = TRUE, exercise.lines = 2, exercise.setup = "clean-gapminder"}
filter(____, ____)
```

```{r filter-japan-check}
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(filter(gapminder, country == "Japan"))
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

`filter()`では、複数の条件を`,`で区切ることで複数条件で絞り込みが可能です。たとえば、1997年に絞り、人あたりのGDPが3万米ドルを超える国を抽出します。

```{r filter-mult-example, exercise = TRUE, exercise.lines = 6, exercise.setup = "clean-gapminder"}
filter(gapminder, year == 1997, gdp_percap > 30000)
```

- Q3: 2007年に、アジア大陸で寿命が65歳未満（65歳を含まない）の国だけに絞ってください（結果は新しいオブジェクトとして保存する必要はありませんが、コードの出力はデータフレームにしてください）。

```{r filter-asia-life, exercise = TRUE, exercise.lines = 2, exercise.setup = "clean-gapminder"}
filter(____, ____, ____, ____)
```

```{r filter-asia-life-check}
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(filter(gapminder, continent == "Asia", life_exp < 65, year == 2007))
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

## データを変更する

### 既存の列を変更する

- Q4: `mutate()`関数を使用して、`pop`を万人単位に変換してください（結果は新しいオブジェクトとして保存する必要はありませんが、コードの出力はデータフレームにしてください）。

```{r mutate-pop, exercise = TRUE, exercise.lines = 2, exercise.setup = "clean-gapminder"}
mutate(____, ____)
```

```{r mutate-pop-check}
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(mutate(gapminder, pop = pop/10000))
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

### 新しい列を作成する

`mutate(列名 = 新しい列を作成する計算式)`の形で使いますが、指定した`列名`が存在しない場合は、新しい列が作成されます。

たとえば、寿命の相対値を`life_exp_rel`として計算します。

```{r mutate-new-example, exercise = TRUE, exercise.lines = 3, exercise.setup = "clean-gapminder"}
mutate(gapminder, life_exp_rel = life_exp / max(life_exp))
```

- `max(life_exp)`は寿命のもっとも大きな値です。つまり、すべての寿命のデータをもっとも大きな寿命で割ることによって、相対的な値を作りました。

###

Q5: 一人当たりの国内総生産（`gdp_percap`）を人口（`pop`）にかけることによって、国内総生産（`gdp`）を計算してください（結果は新しいオブジェクトとして保存してもしなくてもいいですが、コードの出力はデータフレームにしないといけません）。

```{r mutate-gdp, exercise = TRUE, exercise.lines = 2, exercise.setup = "clean-gapminder"}
mutate(____, ____)
```

```{r mutate-gdp-check}
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(mutate(gapminder, gdp = gdp_percap * pop))
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

## パイプ

`|>`（パイプ）は、左側のオブジェクトを右側の関数に渡すための記号です。

例えば、授業では[このように勉強しました](https://joelnitta.github.io/joho-shori/day4/#/%E3%83%91%E3%82%A4%E3%83%97%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9)：

> - `arrange(データ, 列名)`というような書き方をしてきましたが、パイプを使うとこのように書きます：
  - `データ |> arrange(列名)`

- Q6: パイプを使って、Q4の`pop`を万人単位に変換する操作をもう一度行ってください。

```{r mutate-pop-pipe, exercise = TRUE, exercise.lines = 2, exercise.setup = "clean-gapminder"}
____ |> mutate(____)
```

```{r mutate-pop-pipe-check}
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(mutate(gapminder, pop = pop/10000))
    )
    fail_if_not_equal(
      x = str_detect(.result, "\\|>|%>%.*mutate\\("),
      y = TRUE,
      message = "パイプを使う必要があります"
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

- Q7: パイプを使って、Q3の操作（2007年にアジア大陸で寿命が65歳未満の国のデータを抽出）をもう一度行ってください。

```{r filter-asia-pipe, exercise = TRUE, exercise.lines = 2, exercise.setup = "clean-gapminder"}
____ |> filter(____)
```

```{r filter-asia-pipe-check}
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(filter(gapminder, continent == "Asia", life_exp < 65, year == 2007))
    )
    fail_if_not_equal(
      x = str_detect(.result, "\\|>|%>%.*filter\\("),
      y = TRUE,
      message = "パイプを使う必要があります"
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

## パイプライン

複数の操作をパイプでつなげて一連の作業を行うことを「パイプライン」と呼びます。

- Q8: 次のパイプラインを組んでください。
  - `gapminder`から始め、1997年のヨーロッパ（"Europe"）のデータを抽出し、人口を万人単位に変換して、人口の小さい順に並べてください（結果は新しいオブジェクトとして保存する必要はありませんが、コードの出力はデータフレームにしてください）。

```{r europe-pipeline, exercise = TRUE, exercise.lines = 5, exercise.setup = "clean-gapminder"}
____ |>
   filter(____) |>
   mutate(____) |>
   arrange(____)
```

```{r europe-pipeline-check}
  correct_pipeline_result <- gapminder |>
    filter(year == 1997, continent == "Europe") |>
    mutate(pop = pop/10000) |>
    arrange(pop)
  grade_this({
    pass_if_equal(
      x = as.data.frame(.result),
      y = as.data.frame(correct_pipeline_result)
    )
    fail_if_not_equal(
      x = str_detect(.result, "\\|>|%>%"),
      y = TRUE,
      message = "パイプを使う必要があります"
    )
    fail_if_not_equal(
      x = str_detect(.result, "\\|>|%>%.*filter.*\\|>|%>%.*mutate.*\\|>|%>%.*arrange.*"),
      y = TRUE,
      message = "パイプラインの順番が合っていません"
    )
    fail_if_not_equal(
      x = inherits(.result, "data.frame"),
      y = TRUE,
      message = "最後の出力はデータフレームにする必要があります"
    )
    fail()
  })
```

- Q9: データパイプラインを組むことによって、以下の質問に答えてください：`gapminder`のデータの中で、2007年にアフリカ大陸（「Africa」）でもっとも一人当たりの国内総生産が多かった国はどこでしたか？

```{r africa-gdp-example, exercise = TRUE, exercise.lines = 4, exercise.setup = "clean-gapminder"}

```

```{r africa-gdp, echo=FALSE}
question_text(
  text = "国名を言葉一つで記入してください：",
  answer_fn(function(value) {
    answer_lc <- str_to_lower(value)
    if (answer_lc == "gabon") {
      correct()
    } else if (answer_lc == "ガボン") {
      correct()
    } else if (answer_lc == "がぼん") {
      correct()
    } else if (str_detect(answer_lc, " |　")) {
      incorrect("国名のみを入力してください（スペースなど使用しないでください）")
    } else {
      incorrect()
    }
  }, label = "国名"),
  allow_retry = TRUE,
  trim = TRUE
)
```

## 確認と提出

```{r, echo=FALSE, results = "asis"}
res <- knitr::knit_child(
  system.file("rmd", "summarize_score.Rmd", package = "joholearnr"),
  quiet = TRUE)
cat(res, sep = '\n')
```
